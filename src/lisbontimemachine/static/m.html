<!DOCTYPE html> 
<html> 
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/> 
        <!– meta tag for iPhone/iTouch devices –>
        <meta name="viewport" content="height=device-height,width=device-width,initial-scale=1,user-scalable=no" />
  
		<title>Lx Time Machine</title> 
		<style>
		html { height: 100% }
		body { height: 100%; margin: 0px; padding: 0px }
		</style>
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.css" type="text/css"/>
        <script src="http://code.jquery.com/jquery-1.4.4.min.js" type="text/javascript"></script>
        <script src="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.js" type="text/javascript"></script>
	    <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
		<script language="javascript">
			var map = null;
			var panorama = null;
			var lastInfoWindow = null;
			
			function initializeMap() {
				var startPoint = new google.maps.LatLng(38.7220073, -9.1673903);
				
				var mapOptions = {
			      center: startPoint,
			      zoom: 14,
			      mapTypeId: google.maps.MapTypeId.ROADMAP,
			      streetViewControl: true
			    };
				
				map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
				
				google.maps.event.addListener(map, 'center_changed', function() {
					var mapCenterLocation = map.getCenter();

					loadOldPhotosforLocation(mapCenterLocation.lat(), mapCenterLocation.lng());
				});
				
				var panoramaOptions = {
			      position: startPoint,
			      pov: {
			        heading: 34,
			        pitch: 10,
			        zoom: 1
			      }
			    };
			    
				panorama = new  google.maps.StreetViewPanorama(document.getElementById("pano"),panoramaOptions);
			    map.setStreetView(panorama);
			
				google.maps.event.addListener(panorama, 'center_changed', function() {
					var mapCenterLocation = map.getCenter();

					loadOldPhotosforLocation(mapCenterLocation.lat(), mapCenterLocation.lng());
				});
				
			
				var mapCenterLocation = map.getCenter();
				
				loadOldPhotosforLocation(mapCenterLocation.lat(), mapCenterLocation.lng());
			}
		
			function loadOldPhotosforLocation(lat, lng) {
				var url = 'list.json?latitude=' + lat + '&longitude=' + lng;
				$.getJSON(url,
				  function(data) {

				    $.each(data, function(i,item){
						/*
						"title": "Largo do Marqu\u00eas de Angeja",
					    "longitude": "-9.1952104",
					    "date": "1964",
					    "image_url": "http:\/\/cml-hub.mrnet.pt\/mediaRep\/cmlhub\/files\/fotografias\/PT_AMLSB_AF_SER_S03119.jpg",
					    "latitude": "38.6968321",
					    "id": "88"
						
						*/
						var point = new google.maps.LatLng( item.latitude, item.longitude);
					 
					  	var pinImg = new google.maps.MarkerImage('http://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=location|FFFF00');

						var mapMarker = new google.maps.Marker({
						      position: point,
						      map: map,
						      icon: pinImg,
						      title: item.date + ' - ' + item.title
						  });
						
						
						
						 var mapInfowindow = new google.maps.InfoWindow();
						 var tooltipHTML = item.title;
					     mapInfowindow.setContent(tooltipHTML);
					/*
						 google.maps.event.addListener(mapMarker, 'click', function() {
						 	mapInfowindow.open(map, mapMarker);
						 });
					*/	
						google.maps.event.addListener(mapMarker, 'click', function() { 	
							if (lastInfoWindow != null) {
								lastInfoWindow.close();
								lastInfoWindow = null;
								
							}
							map.setCenter(mapMarker.position);
							panorama.setPosition(mapMarker.position);
							
							
							
							mapInfowindow.open(map, mapMarker);
							
							lastInfoWindow = mapInfowindow;
							
						//	panorama.setPov({heading: 140, pitch: +10, zoom: 1});
						var imgHTML = "<img src='" + item.image_url + "' />";
						$('#photoViewer').html(imgHTML);
							//$("#photoViewer").html("<span class='red'>Hello <b>Again</b></span>");
						});

						  var panoramaMarker = new google.maps.Marker({
						      position: point,
						      map: panorama,
						      icon: pinImg,
						      title: item.date + ' - ' + item.title
						  });
						
		
						
						google.maps.event.addListener(panoramaMarker, 'click', function() {
						 	mapInfowindow.open(panorama, panoramaMarker);
						 });
									
				    });
				  });
				
			}
		
		
			$(document).ready(function() {
				initializeMap();
			});

		</script>
	</head>

	<body>
        <div data-role="page" data-theme="a" id="view-map">
           <div data-role="content" data-theme="a">
              <div data-role="header" data-position="fixed">
                  <h1>Lx Time Machine</h1> 
              </div>
              <div data-role="collapsible">
                   <h3>Now Map</h3>
                    
                        <div id="map_canvas" style="width: 100%; height: 240px;"></div>
                      
                </div>
                <div data-role="collapsible">
                   <h3>Look around</h3>
                    
                        <div id="pano" style="width: 100%; height: 240px;"></div>
                     
                </div>
               <div data-role="collapsible">
                    <h3>Then</h3>
   		           <div id="photoViewer" style="width: 400px; height: 300px"></div> 
               </div>
	       </div>
            <div data-role="footer" class="ui-bar-a ui-footer" role="contentinfo">
                <div data-role="navbar" class="ui-navbar" role="navigation">
                    <ul class="ui-grid-a">
                        <li class="ui-block-a"><a data-icon="star" href="#" data-theme="a" class="ui-btn ui-btn-icon-top ui-btn-down-a"><span class="ui-btn-inner"><span class="ui-btn-text">Map</span></span></span></a></li>
                        <li class="ui-block-b"><a data-icon="gear" href="#setup" data-theme="a" data-transition="slideup" class="ui-btn ui-btn-icon-top ui-btn-up-a ui-btn-up-a"><span class="ui-btn-inner"><span class="ui-btn-text">Setup</span></span></span></a></li>
                    </ul>
                </div><!-- /navbar -->
            </div>
       </div>
       
       <!-- Start of second page -->
       <div data-role="page" id="setup">
       
           <div data-role="header">
               <h1>Bar</h1>
           </div><!-- /header -->
       
           <div data-role="content">   
               <p>I'm first in the source order so I'm shown as the page.</p>      
               <p><a href="#foo">Back to foo</a></p>   
           </div><!-- /content -->
       
           <div data-role="footer" class="ui-bar-a ui-footer" role="contentinfo">
                <div data-role="navbar" class="ui-navbar" role="navigation">
                    <ul class="ui-grid-a">
                        <li class="ui-block-a"><a data-icon="star" href="#view-map" data-theme="a" data-transition="slidedown" class="ui-btn ui-btn-up-a"><span class="ui-btn-inner"></span></a></li>
                        <li class="ui-block-b"><a data-icon="gear" href="#" data-theme="a" class="ui-btn ui-btn-icon-top ui-btn-down-a"></a></li>
                    </ul>
                </div><!-- /navbar -->
            </div>
           
       </div><!-- /page -->
       
       
	</body> 
 </html>